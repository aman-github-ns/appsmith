{"version":3,"file":"static/js/metrics-aggregate.454aa114.chunk.js","mappings":"6RAcO,IAAMA,EAAgB,SAAAC,GAY3B,SAAAD,EAAYE,EAAUC,EAAMC,GAAQ,IAAAC,EAAAC,E,MAkB9B,OAlB8BC,EAAAA,EAAAA,GAAA,KAAAP,G,EAClC,K,EAAAA,E,EAAA,CAAMI,G,cAANE,G,oFACKJ,SAAWA,EAChBI,EAAKH,KAAOA,GAAQ,CAAC,EACrBG,EAAKE,SAAU,EACfF,EAAKG,cAAgB,KACrBH,EAAKI,SAAU,EAEfJ,EAAKK,QAAU,IAAIC,EAAAA,EAAQN,EAAKO,gBAGhCC,EAAAA,EAAAA,GAAeR,EAAKS,OAAOC,MAAIC,EAAAA,EAAAA,GAAAX,KAKb,QAAlBD,EAAAC,EAAKO,qBAAa,IAAAR,GAAlBA,EAAoBa,GAAGC,GAAGC,EAAAA,GAAAA,OAAsB,kBAAMd,EAAKe,WAAW,CACpEC,cAAc,GACd,IAAEhB,CACN,CAiHC,OAhJ0BiB,EAAAA,EAAAA,GAAAvB,EAAAC,IAiC3BuB,EAAAA,EAAAA,GAAAxB,EAAA,EAAAyB,IAAA,SAAAC,MAIA,WACMC,KAAKjB,UAELiB,KAAKxB,KAAKyB,UAAUD,KAAKxB,KAAKyB,WAClCD,KAAKN,WAAW,CACdN,QAAQ,IAEZ,GAAC,CAAAU,IAAA,aAAAC,MACD,SAAWG,EAAUC,GACnBH,KAAKE,SAAWA,EAChBF,KAAKnB,SAAU,EACfmB,KAAKI,gBAAgC,MAAhBD,EAAuBA,EAAeH,KAAKE,SAClE,GAAC,CAAAJ,IAAA,YAAAC,MACD,WACE,IAAIM,EAAcC,UAAUC,OAAS,QAAsBC,IAAjBF,UAAU,IAAmBA,UAAU,GACjFN,KAAKjB,QAAUsB,EACfL,KAAKnB,SAAU,EACXmB,KAAKlB,eACP2B,aAAaT,KAAKlB,cAEtB,GAAC,CAAAgB,IAAA,kBAAAC,MACD,SAAgBW,EAAOlC,GAAM,IAAAmC,EAAA,KACvBX,KAAKlB,gBACI,MAAT4B,IACFA,EAAQV,KAAKE,UAEfF,KAAKlB,cAAgB8B,YAAW,WAC9BD,EAAK7B,cAAgB,KACrB6B,EAAKjB,WAAWlB,EAClB,GAAW,IAARkC,GACL,GAAC,CAAAZ,IAAA,aAAAC,MACD,SAAWvB,GAAM,IAAAqC,EAAA,KACf,IAAIb,KAAKjB,QAAT,CAMA,IAKI+B,EACAC,EANEC,EAAiB,SAAAC,GACb,OAAJzC,QAAI,IAAJA,GAAAA,EAAMmB,eAAcsB,EAAOC,OAAQ,GACvCL,EAAKM,kBAAkB3C,EAAMyC,EAC/B,EACIG,EAAW,GAGf,GAAIpB,KAAKxB,KAAK6C,WAAY,CAKxB,KAHAP,EAAeQ,EAAAA,GAA2B,CACxCC,eAAoB,OAAJ/C,QAAI,IAAJA,OAAI,EAAJA,EAAMY,UAEL,OAAO,EAC1B,IAAM8B,IAAa,OAAJ1C,QAAI,IAAJA,GAAAA,EAAMY,SAAU0B,IAAiBQ,EAAAA,GAKhD,KAJAP,EAAUf,KAAKxB,KAAK6C,WAAW,CAC7BH,MAAAA,EACA1C,KAAAA,KAMA,YAHIwB,KAAKnB,SACPmB,KAAKI,mBAITW,EAAsD,mBAA5CS,OAAOC,UAAUC,SAASC,KAAKZ,GAAgCA,EAAU,CAACA,GACpFK,EAASQ,KAAIC,MAAbT,GAAQU,EAAAA,EAAAA,GAASf,GACnB,CAGA,IAAIgB,EAAO,SAAAC,GAAI,OAAInB,EAAK7B,QAAQiD,MAAMD,EAAK,EACvCZ,EAASb,OAEQwB,EAAf/B,KAAKxB,KAAK0D,IAAY,SAAAF,GAAI,OAAInB,EAAK7B,QAAQmD,MAAMH,EAAK,EAC6C,SAAAA,GAAI,OAAInB,EAAK7B,QAAQ+C,KAAKC,EAAK,EAGtIZ,EAASQ,UAAKpB,GAEhBY,EAASgB,SAAQ,SAAArB,GACfgB,EAAK,CACHxD,SAAUsC,EAAKtC,SACfwC,QAAAA,EACAvC,KAAAA,EACAsC,aAAAA,EACAuB,WAAYrB,EACZsB,UAAWzB,EAAKrC,KAAK8D,UACrBJ,IAAKrB,EAAKrC,KAAK0D,KAEnB,IACIlC,KAAKnB,SACPmB,KAAKI,iBAxDiB,CA0D1B,GAAC,CAAAN,IAAA,oBAAAC,MACD,SAAkBvB,EAAMyC,GAItB,GAHIjB,KAAKxB,KAAK+D,YACZvC,KAAKxB,KAAK+D,WAAWtB,GAEnBA,EAAOuB,MAAQvB,EAAOC,MAAO,CAC/B,IAAMR,EAAQO,EAAOP,OAASV,KAAKxB,KAAKiE,WAEpCzC,KAAKnB,SAAW6B,GAClBD,aAAaT,KAAKlB,eAClBkB,KAAKlB,cAAgB,KACrBkB,KAAKI,gBAAgBM,EAAOlC,KAClBwB,KAAKnB,SAAW6B,GAE1BV,KAAKI,gBAAgBM,EAAOlC,EAEhC,CACF,KAACH,CAAA,CAhJ0B,CAASqE,EAAAA,E,wGCPtC,GAAIC,EAAAA,GAAe,CACjBC,EAAAA,GAAAA,aAA2B,GAE3B,IAAMC,EAAYD,EAAAA,GAAAA,MAClBA,EAAAA,GAAAA,MAAoB,WAClB,IACyCE,EADzCC,GAAAC,EAAAA,EAAAA,GACiBJ,EAAAA,GAAAA,cAAwB,IAAzC,IAAAG,EAAAE,MAAAH,EAAAC,EAAAG,KAAAC,MAA2C,EACzCC,EADWN,EAAA/C,QAEb,CAAC,OAAAsD,GAAAN,EAAAO,EAAAD,EAAA,SAAAN,EAAAQ,GAAA,CACDV,GACF,CACF,CAOO,SAAS1D,EAAeqE,GACzBC,EAAAA,KACFC,EAAAA,EAAAA,GAA4BF,GAAI,IAChCG,EAAAA,EAAAA,IAAuB,WAAYH,IAE1Bb,EAAAA,IACTC,EAAAA,GAAAA,aAAAA,KAA8BY,EAGlC,C,mOCjCMI,EACG,QADHA,EAEI,SAFJA,EAGC,MAHDA,EAII,SAJJA,EAKK,UALLA,EAMc,mBANdA,EAOI,SAPJA,EAQO,YARPA,EASI,SATJA,EAUO,YAVPA,EAWO,YAXPA,EAYM,WAZNA,EAaG,QAbHA,EAcI,SAdJA,EAeG,QAfHA,EAgBI,SAhBJA,EAiBM,WAjBNA,EAkBE,OAlBFA,EAmBM,WAEL,SAASC,IACd,IAAKJ,EAAAA,GAAgB,MAAO,GAE5B,IAAMK,EAAa,GACnB,KAmCF,WACE,IACE,OAAOtC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,UAAYxC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,aAAexC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,eAAiBC,SAASC,cAAc,qCAAwC,WAEvP,IADA,IAAMC,EAAOF,SAASG,iBAAiB,cAC9BC,EAAI,EAAGA,EAAIF,EAAK5D,OAAQ8D,IAC/B,GAAI7C,OAAOC,UAAUsC,eAAepC,KAAKwC,EAAKE,GAAI,uBAChD,OAAO,CAGb,CAPyP,EAQ3P,CAAE,MAAOhB,GACP,OAAO,CACT,CACF,EA/CQiB,KACFR,EAAWlC,KAAKgC,GA+CtB,WAEE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,SAAWxC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAOO,KAAM,UACnH,CAAE,MAAOlB,GACP,OAAO,CACT,CACF,CArDUmB,IAAgBV,EAAWlC,KAAKgC,IAsD1C,WACE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,MACtD,CAAE,MAAOX,GACP,OAAO,CACT,CACF,CA1DQoB,KACFX,EAAWlC,KAAKgC,GA0DtB,WAEE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,UAAYxC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAOU,MAAO,OACrH,CAAE,MAAOrB,GACP,OAAO,CACT,CACF,CAhEUsB,IAAgBb,EAAWlC,KAAKgC,IAiE1C,WACE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,OAASC,SAASC,cAAc,eACtF,CAAE,MAAOb,GACP,OAAO,CACT,CACF,CArEQuB,KACFd,EAAWlC,KAAKgC,GAqEtB,WAEE,IACE,OAAOK,SAASC,cAAc,sBAChC,CAAE,MAAOb,GACP,OAAO,CACT,CACF,CA3EUwB,IAA0Bf,EAAWlC,KAAKgC,IA4EpD,WACE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,WACtD,CAAE,MAAOX,GACP,OAAO,CACT,CACF,CAhFQyB,KACFhB,EAAWlC,KAAKgC,GAgFtB,WAEE,IACE,QAASpC,OAAOuD,KAAKf,QAAQgB,MAAK,SAAAC,GAAI,OAAIA,EAAKC,WAAW,cAAc,GAC1E,CAAE,MAAO7B,GACP,OAAO,CACT,CACF,CAtFU8B,IAAmBrB,EAAWlC,KAAKgC,IAuF7C,WACE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,SACtD,CAAE,MAAOX,GACP,OAAO,CACT,CACF,CA3FQ+B,KACFtB,EAAWlC,KAAKgC,GA2FtB,WAEE,IACE,OAAOK,SAASC,cAAc,qCAChC,CAAE,MAAOb,GACP,OAAO,CACT,CACF,CAjGUgC,IAAmBvB,EAAWlC,KAAKgC,IAkG7C,WACE,IACE,OAAOpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,YAAcC,SAASC,cAAc,+GAAiHD,SAASC,cAAc,2DACnO,CAAE,MAAOb,GACP,OAAO,CACT,CACF,CAtGQiC,IAAmBxB,EAAWlC,KAAKgC,GACnCpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,aAAaF,EAAWlC,KAAKgC,GAC1EpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,UAAUF,EAAWlC,KAAKgC,GACvEpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,WAAWF,EAAWlC,KAAKgC,GACxEpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,UAAUF,EAAWlC,KAAKgC,GACvEpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,WAAWF,EAAWlC,KAAKgC,GACxEpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,aAAaF,EAAWlC,KAAKgC,GAC1EpC,OAAOC,UAAUsC,eAAepC,KAAKqC,OAAQ,eAAeF,EAAWlC,KAAKgC,GAgGpF,WACE,IACE,MAA4B,kBAAd2B,WAAyD,kBAAxBA,UAAUC,WAA0BD,UAAUC,UAAUC,QAAQ,aAAe,CAChI,CAAE,MAAOpC,GACP,OAAO,CACT,CACF,CArGQqC,IAAkB5B,EAAWlC,KAAKgC,EACxC,CAAE,MAAOP,GACP,CAEF,OAAOS,CACT,C,sEChDO,IAAM6B,EAAS,SAAAC,GAEpB,SAAAD,EAAYE,EAAiBC,GAAY,IAAAnH,E,MAwBb,OAxBaC,EAAAA,EAAAA,GAAA,KAAA+G,G,EACvC,K,EAAAA,E,EAAA,CAAME,EAAiBC,EAAYC,EAAAA,I,cAAnCpH,G,oFACKqH,aAAa,CAAC,QAAQC,MAAK,SAAAC,IAC9BC,EAAAA,EAAAA,GAAgBD,EAAI,GAAR,IAGQ,IAAI7H,EAAAA,EAAiB,WAAY,CACjD4B,SAAU,kBAAMtB,EAAKS,QAAQ,IAC9BE,EAAAA,EAAAA,GAAAX,IAESK,QAAQQ,GAAG,YAAY,iBAAO,CACtC4G,KAAMzH,EAAKmH,WAAWO,KAAK,CAAC,KAAM,OACnC,IACD1H,EAAK2H,UAEL3H,EAAK4H,SAAU,GACfC,EAAAA,EAAAA,IAAgB7H,EAAKkH,gBAAiBlH,EAAK8H,aAE/C,KAGAC,EAAAA,EAAAA,GAAgBC,EAAAA,GAA+BhI,EAAKiI,2BAA2BvH,MAAIC,EAAAA,EAAAA,GAAAX,IAAQA,EAAK8H,YAAa9H,EAAKY,KAClHmH,EAAAA,EAAAA,GAAgBG,EAAAA,GAAuBlI,EAAKmI,kBAAkBzH,MAAIC,EAAAA,EAAAA,GAAAX,IAAQA,EAAK8H,YAAa9H,EAAKY,IACjGZ,EAAKoI,eACLpI,EAAKqI,oBAAqBrI,CAC5B,CAwHC,OAnJmBiB,EAAAA,EAAAA,GAAA+F,EAAAC,IA2BnB/F,EAAAA,EAAAA,GAAA8F,EAAA,EAAA7F,IAAA,6BAAAC,MACD,SAA2BkH,EAAMlH,GAC/B,IAAIC,KAAKuG,QAAT,CACA,IAAMW,EAAOC,EAAAA,GACPC,EAAS,CACbH,KAAAA,GAEFjH,KAAK8F,WAAWuB,YAAYH,EAAMD,EAAMG,EAAQrH,EALxB,CAM1B,GAAC,CAAAD,IAAA,oBAAAC,MACD,SAAkBkH,EAAMK,GACtB,IAAItH,KAAKuG,QAAT,CACA,IAAMW,EAAOK,EAAAA,GACPH,EAAS,CACbH,KAAAA,GAEFjH,KAAK8F,WAAW0B,MAAMN,EAAMD,EAAMG,EAAQE,EALlB,CAM1B,GAAC,CAAAxH,IAAA,eAAAC,MACD,WAAe,IAAAY,EAAA,KAEb8G,GAGIC,EAAAA,EAAAA,IAAW1H,KAAK6F,iBAFlB8B,EAAUF,EAAVE,WACAC,EAAUH,EAAVG,WAEFC,GAIIC,EAAAA,EAAAA,IAAiB9H,KAAK6F,iBAHxBkC,EAAKF,EAALE,MACAC,EAAOH,EAAPG,QACAC,EAAgBJ,EAAhBI,iBAIF,GAFIL,GAAY5H,KAAK4G,2BAA2B,sBAAsBsB,OAAON,EAAY,cACrFD,GAAY3H,KAAK4G,2BAA2B,sBAAsBsB,OAAOP,EAAY,cACrFlE,EAAAA,GAAgB,KAAA0E,EAClBnI,KAAK4G,2BAA2B,oCAChC,IAAMwB,EAAgB,QAAXD,EAAGlE,gBAAQ,IAAAkE,GAAe,QAAfA,EAARA,EAAUE,qBAAa,IAAAF,OAAA,EAAvBA,EAAyBC,MACnCA,GAAmB,KAAVA,GACXpI,KAAK4G,2BAA2B,mCAIlC0B,EAAAA,EAAAA,KAAmB,WACjBzE,IAAgBzB,SAAQ,SAAAmG,GACtB5H,EAAKiG,2BAA2B,aAAe2B,EAAY,YAC7D,GACF,IACKP,EAAQQ,iBAAiBxI,KAAK4G,2BAA2B,mCAC1DqB,EAAiBQ,WAAWzI,KAAK4G,2BAA2B,0BAClE,MAAWjE,EAAAA,GACT3C,KAAK4G,2BAA2B,mCAEhC5G,KAAK4G,2BAA2B,qCAK9B8B,EAAAA,EAAAA,MACF1I,KAAK4G,2BAA2B,iCAIlC,IAAM+B,GAAQC,EAAAA,EAAAA,IAAS5I,KAAK6F,iBACxB8C,EAAMpI,OAAS,GAAGP,KAAK4G,2BAA2B,8BAClD+B,EAAMpI,OAAS,KAAMsI,EAAAA,EAAAA,IAAcF,IAAQ3I,KAAK4G,2BAA2B,6BAG3EmB,EAAMe,QAAQ9I,KAAK4G,2BAA2B,4BAC9CmB,EAAMgB,QAAQ/I,KAAK4G,2BAA2B,2BACpD,GAAC,CAAA9G,IAAA,oBAAAC,MACD,WAAoB,IAAAc,EAAA,KACb4C,EAAAA,KAGLE,EAAAA,EAAAA,IAAuB,YAAY,SAAAqF,GAC1B,OAAHA,QAAG,IAAHA,GAAAA,EAAKC,WACPpI,EAAK+F,2BAA2B,+BAEpC,GACF,GAAC,CAAA9G,IAAA,SAAAC,MACD,WAAS,IAAAmJ,EAAA,KACP,IAAI,IAAAC,EAcOC,EAAT,SAAgBC,GACd,OAAOC,EAAcC,SAASF,EAAEG,cAClC,EAfA,GAAIxJ,KAAKyJ,cAAe,OACxBzJ,KAAKyJ,eAAgB,EAErB,IAAMC,GAAehC,EAAAA,EAAAA,IAAW1H,KAAK6F,iBAK/ByD,EAAgB,CAAC,SAAU,QAAS,kBACpCK,EAAe,CAAC,cAAe,eAAgB,eAAgB,aAwBrE,KAjBgC,QAAXR,EAAAS,mBAAW,IAAAT,OAAA,EAAXA,EAAaU,iBAAiB,cAAe,IACrDzH,SAAQ,SAAA0H,GAPrB,IAAoBT,IAQHS,EAPRH,EAAaI,MAAK,SAAAC,GAAC,OAAIX,EAAEpC,KAAKxB,QAAQuE,IAAM,CAAC,IAQ9CZ,EAAOU,GAAQZ,EAAKtC,2BAA2B,mCAAwCsC,EAAKtC,2BAA2B,uCAEvHwC,EAAOU,GAAQZ,EAAKtC,2BAA2B,mCAAwCsC,EAAKtC,2BAA2B,sCAE/H,IAII8C,EAAaO,MACfjK,KAAK4G,2BAA2B,8CAA+CsD,KAAKC,MAAMP,YAAYQ,QAK7E,qBAAhBR,YAA6B,CACtC,IAAMS,EAAUT,YAAYC,iBAAiB,QACvCS,EAAWV,YAAYC,iBAAiB,WAC9C7J,KAAK4G,2BAA2B,gCAAiCyD,EAAQ9J,QACzEP,KAAK4G,2BAA2B,mCAAoC0D,EAAS/J,OAC/E,CACF,CAAE,MAAO+C,GACP,CAEJ,KAACqC,CAAA,CAnJmB,CAAS4E,EAAAA,IAoJ9BC,EAAAA,EAAAA,GApJY7E,EAAS,cACCI,EAAAA,G","sources":["../node_modules/@newrelic/browser-agent/dist/esm/common/harvest/harvest-scheduler.js","../node_modules/@newrelic/browser-agent/dist/esm/common/unload/eol.js","../node_modules/@newrelic/browser-agent/dist/esm/features/metrics/aggregate/framework-detection.js","../node_modules/@newrelic/browser-agent/dist/esm/features/metrics/aggregate/index.js"],"sourcesContent":["/*\n * Copyright 2020 New Relic Corporation. All rights reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport * as submitData from '../util/submit-data';\nimport { SharedContext } from '../context/shared-context';\nimport { Harvest } from './harvest';\nimport { subscribeToEOL } from '../unload/eol';\nimport { SESSION_EVENTS } from '../session/constants';\n\n/**\n * Periodically invokes harvest calls and handles retries\n */\nexport class HarvestScheduler extends SharedContext {\n  /**\n     * Create a HarvestScheduler\n     * @param {string} endpoint - The base BAM endpoint name -- ex. 'events'\n     * @param {object} opts - The options used to configure the HarvestScheduler\n     * @param {Function} opts.onFinished - The callback to be fired when a harvest has finished\n     * @param {Function} opts.getPayload - A callback which can be triggered to return a payload for harvesting\n     * @param {number} opts.retryDelay - The number of seconds to wait before retrying after a network failure\n     * @param {boolean} opts.raw - Use a prefabricated payload shape as the harvest payload without the need for formatting\n     * @param {string} opts.customUrl - A custom url that falls outside of the shape of the standard BAM harvester url pattern.  Will use directly instead of concatenating various pieces\n     * @param {*} parent - The parent object, whose state can be passed into SharedContext\n     */\n  constructor(endpoint, opts, parent) {\n    super(parent); // gets any allowed properties from the parent and stores them in `sharedContext`\n    this.endpoint = endpoint;\n    this.opts = opts || {};\n    this.started = false;\n    this.timeoutHandle = null;\n    this.aborted = false; // this controls the per-interval and final harvests for the scheduler (currently per feature specific!)\n\n    this.harvest = new Harvest(this.sharedContext);\n\n    // unload if EOL mechanism fires\n    subscribeToEOL(this.unload.bind(this));\n\n    /* Flush all buffered data if session resets and give up retries. This should be synchronous to ensure that the correct `session` value is sent.\n      Since session-reset generates a new session ID and the ID is grabbed at send-time, any delays or retries would cause the payload to be sent under\n      the wrong session ID. */\n    this.sharedContext?.ee.on(SESSION_EVENTS.RESET, () => this.runHarvest({\n      forceNoRetry: true\n    }));\n  }\n\n  /**\n   * This function is only meant for the last outgoing harvest cycle of a page. It trickles down to using sendBeacon, which should not be used\n   * to send payloads while the page is still active, due to limitations on how much data can be buffered in the API at any one time.\n   */\n  unload() {\n    if (this.aborted) return;\n    // If opts.onUnload is defined, these are special actions to execute before attempting to send the final payload.\n    if (this.opts.onUnload) this.opts.onUnload();\n    this.runHarvest({\n      unload: true\n    });\n  }\n  startTimer(interval, initialDelay) {\n    this.interval = interval;\n    this.started = true;\n    this.scheduleHarvest(initialDelay != null ? initialDelay : this.interval);\n  }\n  stopTimer() {\n    let permanently = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    this.aborted = permanently; // stopping permanently is same as aborting, but this function also cleans up the setTimeout loop\n    this.started = false;\n    if (this.timeoutHandle) {\n      clearTimeout(this.timeoutHandle);\n    }\n  }\n  scheduleHarvest(delay, opts) {\n    if (this.timeoutHandle) return;\n    if (delay == null) {\n      delay = this.interval;\n    }\n    this.timeoutHandle = setTimeout(() => {\n      this.timeoutHandle = null;\n      this.runHarvest(opts);\n    }, delay * 1000);\n  }\n  runHarvest(opts) {\n    if (this.aborted) return;\n\n    /**\n     * This is executed immediately after harvest sends the data via XHR, or if there's nothing to send. Note that this excludes on unloading / sendBeacon.\n     * @param {Object} result\n     */\n    const cbRanAfterSend = result => {\n      if (opts?.forceNoRetry) result.retry = false; // discard unsent data rather than re-queuing for next harvest attempt\n      this.onHarvestFinished(opts, result);\n    };\n    let harvests = [];\n    let submitMethod;\n    let payload;\n    if (this.opts.getPayload) {\n      // Ajax & PVT & SR features provide a callback function to get data for harvesting\n      submitMethod = submitData.getSubmitMethod({\n        isFinalHarvest: opts?.unload\n      });\n      if (!submitMethod) return false;\n      const retry = !opts?.unload && submitMethod === submitData.xhr;\n      payload = this.opts.getPayload({\n        retry,\n        opts\n      });\n      if (!payload) {\n        if (this.started) {\n          this.scheduleHarvest();\n        }\n        return;\n      }\n      payload = Object.prototype.toString.call(payload) === '[object Array]' ? payload : [payload];\n      harvests.push(...payload);\n    }\n\n    /** sendX is used for features that do not supply a preformatted payload via \"getPayload\" */\n    let send = args => this.harvest.sendX(args);\n    if (harvests.length) {\n      /** _send is the underlying method for sending in the harvest, if sending raw we can bypass the other helpers completely which format the payloads */\n      if (this.opts.raw) send = args => this.harvest._send(args);\n      /** send is used to formated the payloads from \"getPayload\" and obfuscate before sending */else send = args => this.harvest.send(args);\n    } else {\n      // force it to run at least once in sendX mode\n      harvests.push(undefined);\n    }\n    harvests.forEach(payload => {\n      send({\n        endpoint: this.endpoint,\n        payload,\n        opts,\n        submitMethod,\n        cbFinished: cbRanAfterSend,\n        customUrl: this.opts.customUrl,\n        raw: this.opts.raw\n      });\n    });\n    if (this.started) {\n      this.scheduleHarvest();\n    }\n  }\n  onHarvestFinished(opts, result) {\n    if (this.opts.onFinished) {\n      this.opts.onFinished(result);\n    }\n    if (result.sent && result.retry) {\n      const delay = result.delay || this.opts.retryDelay;\n      // reschedule next harvest if should be delayed longer\n      if (this.started && delay) {\n        clearTimeout(this.timeoutHandle);\n        this.timeoutHandle = null;\n        this.scheduleHarvest(delay, opts);\n      } else if (!this.started && delay) {\n        // if not running on a timer, schedule a single retry\n        this.scheduleHarvest(delay, opts);\n      }\n    }\n  }\n}","/*\n * Copyright 2020 New Relic Corporation. All rights reserved.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { windowAddEventListener } from '../event-listener/event-listener-opts';\nimport { globalScope, isWorkerScope, isBrowserScope } from '../constants/runtime';\nimport { subscribeToVisibilityChange } from '../window/page-visibility';\nif (isWorkerScope) {\n  globalScope.cleanupTasks = []; // create new list on WorkerGlobalScope to track funcs to run before exiting thread\n\n  const origClose = globalScope.close;\n  globalScope.close = () => {\n    // on worker's EoL signal, execute all \"listeners\", e.g. final harvests\n    for (let task of globalScope.cleanupTasks) {\n      task();\n    }\n    origClose();\n  };\n}\n\n/**\n * Subscribes a provided callback to the time/event when the agent should treat it as end-of-life.\n * This is used, for example, to submit a final harvest and send all remaining data on best-effort.\n * @param {function} cb - func to run before or during the last reliable event or time of an env's life span\n */\nexport function subscribeToEOL(cb) {\n  if (isBrowserScope) {\n    subscribeToVisibilityChange(cb, true); // when user switches tab or hides window, esp. mobile scenario\n    windowAddEventListener('pagehide', cb); // when user navigates away, and because safari iOS v14.4- doesn't fully support vis change\n    // --this ought to be removed once support for version below 14.5 phases out\n  } else if (isWorkerScope) {\n    globalScope.cleanupTasks.push(cb); // close() should run these tasks before quitting thread\n  }\n  // By default (for other env), this fn has no effect.\n}","import { isBrowserScope } from '../../../common/constants/runtime';\nconst FRAMEWORKS = {\n  REACT: 'React',\n  NEXTJS: 'NextJS',\n  VUE: 'Vue',\n  NUXTJS: 'NuxtJS',\n  ANGULAR: 'Angular',\n  ANGULARUNIVERSAL: 'AngularUniversal',\n  SVELTE: 'Svelte',\n  SVELTEKIT: 'SvelteKit',\n  PREACT: 'Preact',\n  PREACTSSR: 'PreactSSR',\n  ANGULARJS: 'AngularJS',\n  BACKBONE: 'Backbone',\n  EMBER: 'Ember',\n  METEOR: 'Meteor',\n  ZEPTO: 'Zepto',\n  JQUERY: 'Jquery',\n  MOOTOOLS: 'MooTools',\n  QWIK: 'Qwik',\n  ELECTRON: 'Electron'\n};\nexport function getFrameworks() {\n  if (!isBrowserScope) return []; // don't bother detecting frameworks if not in the main window context\n\n  const frameworks = [];\n  try {\n    if (detectReact()) {\n      frameworks.push(FRAMEWORKS.REACT);\n      if (detectNextJS()) frameworks.push(FRAMEWORKS.NEXTJS);\n    }\n    if (detectVue()) {\n      frameworks.push(FRAMEWORKS.VUE);\n      if (detectNuxtJS()) frameworks.push(FRAMEWORKS.NUXTJS);\n    }\n    if (detectAngular()) {\n      frameworks.push(FRAMEWORKS.ANGULAR);\n      if (detectAngularUniversal()) frameworks.push(FRAMEWORKS.ANGULARUNIVERSAL);\n    }\n    if (detectSvelte()) {\n      frameworks.push(FRAMEWORKS.SVELTE);\n      if (detectSvelteKit()) frameworks.push(FRAMEWORKS.SVELTEKIT);\n    }\n    if (detectPreact()) {\n      frameworks.push(FRAMEWORKS.PREACT);\n      if (detectPreactSSR()) frameworks.push(FRAMEWORKS.PREACTSSR);\n    }\n    if (detectAngularJs()) frameworks.push(FRAMEWORKS.ANGULARJS);\n    if (Object.prototype.hasOwnProperty.call(window, 'Backbone')) frameworks.push(FRAMEWORKS.BACKBONE);\n    if (Object.prototype.hasOwnProperty.call(window, 'Ember')) frameworks.push(FRAMEWORKS.EMBER);\n    if (Object.prototype.hasOwnProperty.call(window, 'Meteor')) frameworks.push(FRAMEWORKS.METEOR);\n    if (Object.prototype.hasOwnProperty.call(window, 'Zepto')) frameworks.push(FRAMEWORKS.ZEPTO);\n    if (Object.prototype.hasOwnProperty.call(window, 'jQuery')) frameworks.push(FRAMEWORKS.JQUERY);\n    if (Object.prototype.hasOwnProperty.call(window, 'MooTools')) frameworks.push(FRAMEWORKS.MOOTOOLS);\n    if (Object.prototype.hasOwnProperty.call(window, 'qwikevents')) frameworks.push(FRAMEWORKS.QWIK);\n    if (detectElectron()) frameworks.push(FRAMEWORKS.ELECTRON);\n  } catch (err) {\n    // Possibly not supported\n  }\n  return frameworks;\n}\nfunction detectReact() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'React') || Object.prototype.hasOwnProperty.call(window, 'ReactDOM') || Object.prototype.hasOwnProperty.call(window, 'ReactRedux') || document.querySelector('[data-reactroot], [data-reactid]') || (() => {\n      const divs = document.querySelectorAll('body > div');\n      for (let i = 0; i < divs.length; i++) {\n        if (Object.prototype.hasOwnProperty.call(divs[i], '_reactRootContainer')) {\n          return true;\n        }\n      }\n    })();\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectNextJS() {\n  // React SSR\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'next') && Object.prototype.hasOwnProperty.call(window.next, 'version');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectVue() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'Vue');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectNuxtJS() {\n  // Vue SSR\n  try {\n    return Object.prototype.hasOwnProperty.call(window, '$nuxt') && Object.prototype.hasOwnProperty.call(window.$nuxt, 'nuxt');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngular() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'ng') || document.querySelector('[ng-version]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngularUniversal() {\n  // Anguler SSR\n  try {\n    return document.querySelector('[ng-server-context]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectSvelte() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, '__svelte');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectSvelteKit() {\n  // Svelte SSR\n  try {\n    return !!Object.keys(window).find(prop => prop.startsWith('__sveltekit'));\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectPreact() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'preact');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectPreactSSR() {\n  // Svelte SSR\n  try {\n    return document.querySelector('script[type=\"__PREACT_CLI_DATA__\"]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectAngularJs() {\n  try {\n    return Object.prototype.hasOwnProperty.call(window, 'angular') || document.querySelector('.ng-binding, [ng-app], [data-ng-app], [ng-controller], [data-ng-controller], [ng-repeat], [data-ng-repeat]') || document.querySelector('script[src*=\"angular.js\"], script[src*=\"angular.min.js\"]');\n  } catch (err) {\n    return false;\n  }\n}\nfunction detectElectron() {\n  try {\n    return typeof navigator === 'object' && typeof navigator.userAgent === 'string' && navigator.userAgent.indexOf('Electron') >= 0;\n  } catch (err) {\n    return false;\n  }\n}","import { getRuntime, getConfiguration } from '../../../common/config/config';\nimport { registerHandler } from '../../../common/event-emitter/register-handler';\nimport { HarvestScheduler } from '../../../common/harvest/harvest-scheduler';\nimport { FEATURE_NAME, SUPPORTABILITY_METRIC, CUSTOM_METRIC, SUPPORTABILITY_METRIC_CHANNEL, CUSTOM_METRIC_CHANNEL } from '../constants';\nimport { getFrameworks } from './framework-detection';\nimport { isFileProtocol } from '../../../common/url/protocol';\nimport { getRules, validateRules } from '../../../common/util/obfuscate';\nimport { onDOMContentLoaded } from '../../../common/window/load';\nimport { windowAddEventListener } from '../../../common/event-listener/event-listener-opts';\nimport { isBrowserScope, isWorkerScope } from '../../../common/constants/runtime';\nimport { AggregateBase } from '../../utils/aggregate-base';\nimport { deregisterDrain } from '../../../common/drain/drain';\nexport class Aggregate extends AggregateBase {\n  static featureName = FEATURE_NAME;\n  constructor(agentIdentifier, aggregator) {\n    super(agentIdentifier, aggregator, FEATURE_NAME);\n    this.waitForFlags(['err']).then(_ref => {\n      let [errFlag] = _ref;\n      if (errFlag) {\n        // *cli, Mar 23 - Per NR-94597, this feature should only harvest ONCE at the (potential) EoL time of the page.\n        const scheduler = new HarvestScheduler('jserrors', {\n          onUnload: () => this.unload()\n        }, this);\n        // this is needed to ensure EoL is \"on\" and sent\n        scheduler.harvest.on('jserrors', () => ({\n          body: this.aggregator.take(['cm', 'sm'])\n        }));\n        this.drain();\n      } else {\n        this.blocked = true; // if rum response determines that customer lacks entitlements for spa endpoint, this feature shouldn't harvest\n        deregisterDrain(this.agentIdentifier, this.featureName);\n      }\n    });\n\n    // Allow features external to the metrics feature to capture SMs and CMs through the event emitter\n    registerHandler(SUPPORTABILITY_METRIC_CHANNEL, this.storeSupportabilityMetrics.bind(this), this.featureName, this.ee);\n    registerHandler(CUSTOM_METRIC_CHANNEL, this.storeEventMetrics.bind(this), this.featureName, this.ee);\n    this.singleChecks(); // checks that are run only one time, at script load\n    this.eachSessionChecks(); // the start of every time user engages with page\n  }\n  storeSupportabilityMetrics(name, value) {\n    if (this.blocked) return;\n    const type = SUPPORTABILITY_METRIC;\n    const params = {\n      name\n    };\n    this.aggregator.storeMetric(type, name, params, value);\n  }\n  storeEventMetrics(name, metrics) {\n    if (this.blocked) return;\n    const type = CUSTOM_METRIC;\n    const params = {\n      name\n    };\n    this.aggregator.store(type, name, params, metrics);\n  }\n  singleChecks() {\n    // report loaderType\n    const {\n      distMethod,\n      loaderType\n    } = getRuntime(this.agentIdentifier);\n    const {\n      proxy,\n      privacy,\n      page_view_timing\n    } = getConfiguration(this.agentIdentifier);\n    if (loaderType) this.storeSupportabilityMetrics(\"Generic/LoaderType/\".concat(loaderType, \"/Detected\"));\n    if (distMethod) this.storeSupportabilityMetrics(\"Generic/DistMethod/\".concat(distMethod, \"/Detected\"));\n    if (isBrowserScope) {\n      this.storeSupportabilityMetrics('Generic/Runtime/Browser/Detected');\n      const nonce = document?.currentScript?.nonce;\n      if (nonce && nonce !== '') {\n        this.storeSupportabilityMetrics('Generic/Runtime/Nonce/Detected');\n      }\n\n      // These SMs are used by the AppExp team\n      onDOMContentLoaded(() => {\n        getFrameworks().forEach(framework => {\n          this.storeSupportabilityMetrics('Framework/' + framework + '/Detected');\n        });\n      });\n      if (!privacy.cookies_enabled) this.storeSupportabilityMetrics('Config/SessionTracking/Disabled');\n      if (page_view_timing.long_task) this.storeSupportabilityMetrics('Config/LongTask/Enabled');\n    } else if (isWorkerScope) {\n      this.storeSupportabilityMetrics('Generic/Runtime/Worker/Detected');\n    } else {\n      this.storeSupportabilityMetrics('Generic/Runtime/Unknown/Detected');\n    }\n\n    // Track if the agent is being loaded using a file protocol such as is the case in some\n    // set-top box applications or Electron applications\n    if (isFileProtocol()) {\n      this.storeSupportabilityMetrics('Generic/FileProtocol/Detected');\n    }\n\n    // Capture SMs to assess customer engagement with the obfuscation config\n    const rules = getRules(this.agentIdentifier);\n    if (rules.length > 0) this.storeSupportabilityMetrics('Generic/Obfuscate/Detected');\n    if (rules.length > 0 && !validateRules(rules)) this.storeSupportabilityMetrics('Generic/Obfuscate/Invalid');\n\n    // Check if proxy for either chunks or beacon is being used\n    if (proxy.assets) this.storeSupportabilityMetrics('Config/AssetsUrl/Changed');\n    if (proxy.beacon) this.storeSupportabilityMetrics('Config/BeaconUrl/Changed');\n  }\n  eachSessionChecks() {\n    if (!isBrowserScope) return;\n\n    // [Temporary] Report restores from BFCache to NR1 while feature flag is in place in lieu of sending pageshow events.\n    windowAddEventListener('pageshow', evt => {\n      if (evt?.persisted) {\n        this.storeSupportabilityMetrics('Generic/BFCache/PageRestored');\n      }\n    });\n  }\n  unload() {\n    try {\n      if (this.resourcesSent) return;\n      this.resourcesSent = true; // make sure this only gets sent once\n\n      const agentRuntime = getRuntime(this.agentIdentifier);\n\n      // Capture SMs around network resources using the performance API to assess\n      // work to split this out from the ST nodes\n      // differentiate between internal+external and ajax+non-ajax\n      const ajaxResources = ['beacon', 'fetch', 'xmlhttprequest'];\n      const internalUrls = ['nr-data.net', 'newrelic.com', 'nr-local.net', 'localhost'];\n      function isInternal(x) {\n        return internalUrls.some(y => x.name.indexOf(y) >= 0);\n      }\n      function isAjax(x) {\n        return ajaxResources.includes(x.initiatorType);\n      }\n      const allResources = performance?.getEntriesByType('resource') || [];\n      allResources.forEach(entry => {\n        if (isInternal(entry)) {\n          if (isAjax(entry)) this.storeSupportabilityMetrics('Generic/Resources/Ajax/Internal');else this.storeSupportabilityMetrics('Generic/Resources/Non-Ajax/Internal');\n        } else {\n          if (isAjax(entry)) this.storeSupportabilityMetrics('Generic/Resources/Ajax/External');else this.storeSupportabilityMetrics('Generic/Resources/Non-Ajax/External');\n        }\n      });\n\n      // Capture SMs for session trace if active (`ptid` is set when returned by replay ingest).\n      // Retain these SMs while we are working through the session_replay feature\n      if (agentRuntime.ptid) {\n        this.storeSupportabilityMetrics('PageSession/Feature/SessionTrace/DurationMs', Math.round(performance.now()));\n      }\n\n      // Capture SMs for performance markers and measures to assess the usage and possible inclusion of this\n      // data in the agent for use in NR\n      if (typeof performance !== 'undefined') {\n        const markers = performance.getEntriesByType('mark');\n        const measures = performance.getEntriesByType('measure');\n        this.storeSupportabilityMetrics('Generic/Performance/Mark/Seen', markers.length);\n        this.storeSupportabilityMetrics('Generic/Performance/Measure/Seen', measures.length);\n      }\n    } catch (e) {\n      // do nothing\n    }\n  }\n}"],"names":["HarvestScheduler","_SharedContext","endpoint","opts","parent","_this$sharedContext","_this","_classCallCheck","started","timeoutHandle","aborted","harvest","Harvest","sharedContext","subscribeToEOL","unload","bind","_assertThisInitialized","ee","on","SESSION_EVENTS","runHarvest","forceNoRetry","_inherits","_createClass","key","value","this","onUnload","interval","initialDelay","scheduleHarvest","permanently","arguments","length","undefined","clearTimeout","delay","_this2","setTimeout","_this3","submitMethod","payload","cbRanAfterSend","result","retry","onHarvestFinished","harvests","getPayload","submitData","isFinalHarvest","Object","prototype","toString","call","push","apply","_toConsumableArray","send","args","sendX","raw","_send","forEach","cbFinished","customUrl","onFinished","sent","retryDelay","SharedContext","isWorkerScope","globalScope","origClose","_step","_iterator","_createForOfIteratorHelper","s","n","done","task","err","e","f","cb","isBrowserScope","subscribeToVisibilityChange","windowAddEventListener","FRAMEWORKS","getFrameworks","frameworks","hasOwnProperty","window","document","querySelector","divs","querySelectorAll","i","detectReact","next","detectNextJS","detectVue","$nuxt","detectNuxtJS","detectAngular","detectAngularUniversal","detectSvelte","keys","find","prop","startsWith","detectSvelteKit","detectPreact","detectPreactSSR","detectAngularJs","navigator","userAgent","indexOf","detectElectron","Aggregate","_AggregateBase","agentIdentifier","aggregator","FEATURE_NAME","waitForFlags","then","_ref","_slicedToArray","body","take","drain","blocked","deregisterDrain","featureName","registerHandler","SUPPORTABILITY_METRIC_CHANNEL","storeSupportabilityMetrics","CUSTOM_METRIC_CHANNEL","storeEventMetrics","singleChecks","eachSessionChecks","name","type","SUPPORTABILITY_METRIC","params","storeMetric","metrics","CUSTOM_METRIC","store","_getRuntime","getRuntime","distMethod","loaderType","_getConfiguration","getConfiguration","proxy","privacy","page_view_timing","concat","_document","nonce","currentScript","onDOMContentLoaded","framework","cookies_enabled","long_task","isFileProtocol","rules","getRules","validateRules","assets","beacon","evt","persisted","_this4","_performance","isAjax","x","ajaxResources","includes","initiatorType","resourcesSent","agentRuntime","internalUrls","performance","getEntriesByType","entry","some","y","ptid","Math","round","now","markers","measures","AggregateBase","_defineProperty"],"sourceRoot":""}