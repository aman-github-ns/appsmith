"use strict";(self.webpackChunkappsmith=self.webpackChunkappsmith||[]).push([[2242],{27168:function(e,t,i){function n(e){var t,i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=(null===s||void 0===s?void 0:s.leading)||!1;return function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];r&&void 0===t&&(e.apply(i,o),t=setTimeout((function(){t=clearTimeout(t)}),n)),r||(clearTimeout(t),t=setTimeout((function(){e.apply(i,o)}),n))}}function s(e){var t=this,i=!1;return function(){if(!i){i=!0;for(var n=arguments.length,s=new Array(n),r=0;r<n;r++)s[r]=arguments[r];e.apply(t,s)}}}i.d(t,{D:function(){return n},Z:function(){return s}})},35315:function(e,t,i){i.r(t),i.d(t,{setupAgentSession:function(){return K}});var n=i(1413),s=i(19435),r=i(21782),o=i(38894),a=i(68295),u=i(4942),c=i(15671),h=i(43144),l=i(42437),v=i(31390),d=i(17610),f=function(){function e(t,i){if((0,c.Z)(this,e),!t.onEnd)throw new Error("onEnd handler is required");if(!i)throw new Error("ms duration is required");this.onEnd=t.onEnd,this.initialMs=i,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,i)}return(0,h.Z)(e,[{key:"create",value:function(e,t){var i=this;return this.timer&&this.clear(),setTimeout((function(){return e?e():i.onEnd()}),t||this.initialMs)}},{key:"clear",value:function(){clearTimeout(this.timer),this.timer=null}},{key:"end",value:function(){this.clear(),this.onEnd()}},{key:"isValid",value:function(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}]),e}(),m=i(63711),y=i(73198),p=i(82963),k=i(78814),g=i(61120),w=i(97326),M=i(60136),A=i(73087),E=i(27168);var S=function(e){function t(e,i){var n,s,r,o;(0,c.Z)(this,t),s=this,r=t,o=[e,i],r=(0,g.Z)(r),(n=(0,p.Z)(s,(0,k.Z)()?Reflect.construct(r,o||[],(0,g.Z)(s).constructor):r.apply(s,o))).onPause="function"===typeof e.onPause?e.onPause:function(){},n.onRefresh="function"===typeof e.onRefresh?e.onRefresh:function(){},n.onResume="function"===typeof e.onResume?e.onResume:function(){},n.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{n.abortController=new AbortController}catch(o){}if(m.il&&e.ee){var a;if(e.ee){n.ee=e.ee;var u=(0,E.D)(n.refresh.bind((0,w.Z)(n)),500,{leading:!0});n.refreshHandler=function(t){var i;e.refreshEvents.includes(null===t||void 0===t||null===(i=t[0])||void 0===i?void 0:i.type)&&u()},e.ee.on("fn-end",n.refreshHandler)}(0,A.N)((function(e){"hidden"===e?n.pause():n.resume()}),!1,!1,null===(a=n.abortController)||void 0===a?void 0:a.signal)}return n}return(0,M.Z)(t,e),(0,h.Z)(t,[{key:"abort",value:function(){var e;this.clear(),null===(e=this.abortController)||void 0===e||e.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}},{key:"pause",value:function(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}},{key:"resume",value:function(){this.refresh(),this.onResume()}},{key:"refresh",value:function(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}]),t}(f),T=i(62658),Z=i(94070),x=i(38450),D=i(12088),b=i(30733),I=i(98841),P={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:y.IK.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:y.IK.OFF,traceHarvestStarted:!1,custom:{}},R=function(){function e(t){var i=this;(0,c.Z)(this,e);var n=t.agentIdentifier,s=t.key,r=t.storage;if(!n||!s||!r)throw new Error("Missing required field(s):".concat(n?"":" agentID").concat(s?"":" key").concat(r?"":" storage"));this.agentIdentifier=n,this.storage=r,this.state={},this.key=s,this.ee=o.ee.get(n),(0,T.em)(this.ee),this.setup(t),m.il&&(0,I.bP)("storage",(function(e){if(e.key===i.lookupKey){var t="string"===typeof e.newValue?JSON.parse(e.newValue):e.newValue;i.sync(t),i.ee.emit(y.wO.UPDATE,[y.uT.CROSS_TAB,i.state])}}))}return(0,h.Z)(e,[{key:"setup",value:function(e){var t=this,i=e.value,n=void 0===i?(0,l.ky)(16):i,s=e.expiresMs,r=void 0===s?y.oD:s,o=e.inactiveMs,a=void 0===o?y.Hb:o;this.state={},this.sync(P),this.state.value=n,this.expiresMs=r,this.inactiveMs=a;var u=this.read();r?(this.state.expiresAt=(null===u||void 0===u?void 0:u.expiresAt)||this.getFutureTimestamp(r),this.expiresTimer=new f({onEnd:function(){t.collectSM("expired"),t.collectSM("duration"),t.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,a?(this.state.inactiveAt=(null===u||void 0===u?void 0:u.inactiveAt)||this.getFutureTimestamp(a),this.inactiveTimer=new S({onEnd:function(){t.collectSM("inactive"),t.collectSM("duration"),t.reset()},onRefresh:this.refresh.bind(this),onResume:function(){t.ee.emit(y.wO.RESUME)},onPause:function(){t.initialized&&t.ee.emit(y.wO.PAUSE),t.write((0,Z.D)(t.state,P))},ee:this.ee,refreshEvents:["click","keydown","scroll"]},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew||(this.isNew=!Object.keys(u).length),this.isNew?this.write((0,Z.D)(this.state,P),!0):this.sync(u),this.initialized=!0}},{key:"lookupKey",get:function(){return"".concat(y.Bq,"_").concat(this.key)}},{key:"sync",value:function(e){Object.assign(this.state,e)}},{key:"read",value:function(){try{var e=this.storage.get(this.lookupKey);if(!e)return{};var t="string"===typeof e?JSON.parse(e):e;return this.isInvalid(t)?{}:this.isExpired(t.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset()):this.isExpired(t.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset()):t}catch(i){return(0,v.Z)("Failed to read from storage API",i),{}}}},{key:"write",value:function(e){try{if(!e||"object"!==typeof e)return;return e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,(0,d.P)(this.state)),this.ee.emit(y.wO.UPDATE,[y.uT.SAME_TAB,this.state]),e}catch(t){return(0,v.Z)("Failed to write to the storage API",t),null}}},{key:"reset",value:function(){try{var e,t,i,n;return this.initialized&&this.ee.emit(y.wO.RESET),this.storage.remove(this.lookupKey),null===(e=this.inactiveTimer)||void 0===e||null===(t=e.abort)||void 0===t||t.call(e),null===(i=this.expiresTimer)||void 0===i||null===(n=i.clear)||void 0===n||n.call(i),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs}),this.read()}catch(s){return{}}}},{key:"refresh",value:function(){var e=this.read();this.write((0,n.Z)((0,n.Z)({},e),{},{inactiveAt:this.getFutureTimestamp(this.inactiveMs)}))}},{key:"isExpired",value:function(e){return Date.now()>e}},{key:"isInvalid",value:function(e){return!Object.keys(P).every((function(t){return Object.keys(e).includes(t)}))}},{key:"collectSM",value:function(e,t,i){var n,s;"duration"===e&&(n=this.getDuration(t,i),s="Session/Duration/Ms"),"expired"===e&&(s="Session/Expired/Seen"),"inactive"===e&&(s="Session/Inactive/Seen"),s&&(0,x.p)(D.xS,[s,n],void 0,b.D.metrics,this.ee)}},{key:"getDuration",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state,t=arguments.length>1?arguments[1]:void 0,i=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-i}},{key:"getFutureTimestamp",value:function(e){return Date.now()+e}},{key:"syncCustomAttribute",value:function(e,t){if(m.il)if(null===t){var i=this.read();i.custom&&(delete i.custom[e],this.write((0,n.Z)({},i)))}else{var s=this.read();this.custom=(0,n.Z)((0,n.Z)({},(null===s||void 0===s?void 0:s.custom)||{}),{},(0,u.Z)({},e,t)),this.write((0,n.Z)((0,n.Z)({},s),{},{custom:this.custom}))}}}]),e}(),O=function(){function e(){(0,c.Z)(this,e)}return(0,h.Z)(e,[{key:"get",value:function(e){try{return localStorage.getItem(e)||void 0}catch(t){return""}}},{key:"set",value:function(e,t){try{return void 0===t||null===t?this.remove(e):localStorage.setItem(e,t)}catch(i){}}},{key:"remove",value:function(e){try{localStorage.removeItem(e)}catch(t){}}}]),e}(),C=function(){function e(t){(0,c.Z)(this,e),this.domain=t}return(0,h.Z)(e,[{key:"get",value:function(e){try{var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}catch(i){return""}}},{key:"set",value:function(e,t){try{var i="".concat(e,"=").concat(t,"; Domain=").concat(this.domain,"; Path=/");document.cookie=i}catch(n){}}},{key:"remove",value:function(e){try{document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; Domain=").concat(this.domain,"; Path=/")}catch(t){}}}]),e}(),F=0;function K(e){var t=(0,s.OP)(e);if(F++)return t.session;var i=(0,s.P_)(e).session,u=null!==i&&void 0!==i&&i.domain?new C(i.domain):new O;t.session=new R({agentIdentifier:e,key:y.K4,storage:u,expiresMs:null===i||void 0===i?void 0:i.expiresMs,inactiveMs:null===i||void 0===i?void 0:i.inactiveMs});var c=t.session.state.custom,h=(0,s.C5)(e);c&&(h.jsAttributes=(0,n.Z)((0,n.Z)({},h.jsAttributes),c));var l=o.ee.get(e);return(0,a.X)("api-setCustomAttribute",(function(e,i,n){t.session.syncCustomAttribute(i,n)}),"session",l),(0,a.X)("api-setUserId",(function(e,i,n){t.session.syncCustomAttribute(i,n)}),"session",l),(0,r.LP)(e,"session"),t.session}}}]);
//# sourceMappingURL=session-manager.8a2b797d.chunk.js.map